<!DOCTYPE html>
<html lang="en">
<head>
  <title>WebSocket Client</title>
  <meta charset="UTF-8" />
  <script type="text/javascript" src="js/jquery-2.1.4.min.js"></script>
  <script>
    "use strict";
    // helper functions for showing divs!
    function show_roomlist() {
      $('#welcome_step1').fadeOut(300).delay(0.3).css('height', 0);
      $('#mainscreen').fadeOut(300).delay(0.3).css('height', 0);
      setTimeout(function(){
        $('#roomlist').css('top', 0).fadeIn(300).delay(0.3);
        window.scrollTo(0, 1);
      })
    }

    function create_room() {
      $('#welcome_step1').fadeOut(300).delay(0.3).css('height', 0);
      $('#mainscreen').fadeOut(300).delay(0.3).css('height', 0);
      socket.send(JSON.stringify({uuid: uuid, type: 'create'}));
    }

    function get_rooms() {
      socket.send(JSON.stringify({uuid: uuid, type: 'get_rooms'}));
    }

    function join_room(index) {
      setTimeout(function(){
        $('#roomlist').css('top', 0).fadeOut(300).delay(0.3);
        window.scrollTo(0, 1);
      })
      socket.send(JSON.stringify({uuid: uuid, type: 'join', room_index: index}));
    }


    var socket; // temporary
    var uuid;

    window.addEventListener("load", function(event) {
      document.onkeydown = checkKey;

      function checkKey(e) {

        e = e || window.event;
        var msg = {uuid: uuid, type: 'move'};

        if (e.keyCode == '38') {
          msg.dir = 'n';
        }
        else if (e.keyCode == '40') {
          msg.dir = 's';
        }
        else if (e.keyCode == '37') {
          msg.dir = 'w';
        }
        else if (e.keyCode == '39') {
          msg.dir = 'e';
        }

        socket.send(JSON.stringify(msg));

      }
      // wait until the page is loaded to do this stuff
      status = "Not Connected";
      var url = "ws://localhost:9001";

      // create socket object, everything will be sent over this
      /*var */socket = new WebSocket(url, "echo-protocol");

      socket.addEventListener("open", function(event) {
        // this runs when the socket is first opened
      });

      socket.addEventListener("message", function(event) {
        // this runs when the socket receives a message from the server
        try {
          // res contains the json representation of the protocol
          var cmd = JSON.parse(event.data);

          // do protocol parsing here

          if (cmd.uuid && uuid == undefined) {
            // we've received a uuid, use that locally
            uuid = cmd.uuid;
            console.log(uuid + ' assigned!');
          }
          if (cmd.type != undefined) {
            switch(cmd.type) {
            case 'room_info':
              var result_string = '';
              // populate 
              show_roomlist();
              for (var room_index in cmd.rooms) {
                var cur_room = cmd.rooms[room_index];
                result_string += '<button id=' + room_index + ' onclick="join_room(this.id)">Players: ' + cur_room.players + '</button>'
              }
              $('#roomlist').html(result_string);
              console.log(cmd);
              break;
            }
          }

        } catch (e) {
          $('#fuck').html(event.data);
          // console.log(e);
        }
        console.log('[SERVER] ' + event.data);
      });

      // when an error happens, this is triggered
      socket.addEventListener("error", function(event) {
        // message.textContent = "Error: " + event;
      });

      socket.addEventListener("close", function(event) {
        open.disabled = false;
      });

    });
  </script>
</head>
<body>
  <center>
    <div id="mainscreen" style="">
      Welcome to Roguecedural!
      <div id="buttons">
        <button id="create_room" onClick="create_room()">Create Dungeon</button>
        <button id="join_room" onClick="get_rooms()">Join Dungeon</button>
      </div>
    </div>
    <div id="roomlist" style="display: none">
      Room list is here, lads.
    </div>
  <span id="fuck" style="font-family: Courier;letter-spacing: 8px;">Placeholder.</span>
  </center>
</body>
</html>