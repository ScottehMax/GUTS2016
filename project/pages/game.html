<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Game</title>

  <script type="text/javascript" src="/js/jquery-2.1.4.min.js"></script>
  <link rel="stylesheet" href="/css/style.css" type="text/css" />
</head>
<body class="debug">
  <div id="intro">
    <h1>Rogue game</h1>
    <div class="intro__container">
      <div class="intro__containerTitle">
        New Dungeon
      </div>
      <div class="intro__containerButton">
        <button id="create_room" onClick="create_room()">Create Dungeon</button>
      </div>
    </div>

    <div class="intro__container">
      <div class="intro__containerTitle">
        Join Dungeon
      </div>
    </div>

    <div id="intro__joinContainer">

      <div class="intro__container">
        <div class="intro__containerTitle--small">
          0 Players
        </div>
        <div class="intro__containerButton">
          <button id="create_room" onClick="create_room()">Join This Dungeon</button>
        </div>
      </div>

    </div>
  </div>
  <div id="main" class="to3d">
    <canvas width="704" height="704" id="game__ground"></canvas>
    <div id="game__walls"></div>
    <canvas width="704" height="704" id="game__ceiling"></canvas>
    <div id="mask"></div>
  </div>

  <script type="text/javascript">
    function create_room() {
      $('#intro').remove();
      $('#main').show().css('opacity', 1);
      socket.send(JSON.stringify({uuid: uuid, type: 'create'}));
    }

    function join_room(index) {
      $('#intro').remove();
      $('#main').show().css('opacity', 1);
      socket.send(JSON.stringify({uuid: uuid, type: 'join', room_index: index}));
    }

    function loadImages(sources, callback) {
      var images = {};
      var loadedImages = 0;
      var numImages = sources.length;
      for(var i = 0; i < sources.length; i++) {
        var imgName = sources[i].split('.')[0];
        images[imgName] = new Image();
        images[imgName].onload = function() {
          if(++loadedImages >= numImages) {
            callback(images);
          }
        };
        images[imgName].src = '/img/' + sources[i];
      }
    }

    function populate(board) {
      if (board === map) return false;
      map = board;

      console.log('populating');
      $('#game__walls').empty();
      canvas.ceiling.clearRect(0, 0, 704, 704);
      canvas.sprite.clearRect(0, 0, 704, 704);
      canvas.ground.clearRect(0, 0, 704, 704);

      for (var i = 0; i < 11; i++) {
        var row = board[i];
        for (var j = 0; j < 11; j++) {
          if (row[j].type === 'solid') {
            canvas.ceiling.drawImage(images['wall' + row[j].sprite], j * 64, i * 64);

            // draw wall
            if (i < 10 && board[i+1][j].type !== 'solid') {
              $('#game__walls').append('<div class="wall" style="bottom: ' + (11 - i - 1) * 64 + 'px; left: ' + j * 64 + 'px"><img src="/img/tiles/stone2.png"></div>');
            }
          } else if (row[j].type === 'tunnel' || row[j].type  === 'floor') {
            canvas.ground.drawImage(images['tiles/stone' + row[j].sprite], j * 64, i * 64);
          } else if (row[j].type === 'lava') {
            canvas.ground.drawImage(images['tiles/lava' + row[j].sprite], j * 64, i * 64);
          } else if (row[j].type === 'water' || row[j].type  === 'closed_door') {
            canvas.ground.drawImage(images['tiles/water' + row[j].sprite], j * 64, i * 64);
          } else if (row[j].type === 'open_door') {
            canvas.ground.drawImage(images['tiles/stone3'], j * 64, i * 64);
          }

        }
      }
    }

    status = "Not Connected";
    var url = "ws://localhost:9001";

    var uuid, images, map, socket;

    "use strict";

    var canvas = {
      'ground' : document.getElementById('game__ground').getContext('2d'),
      'ceiling' : document.getElementById('game__ceiling').getContext('2d')
    };

    var sources = [
      'tiles/stone1.png',
      'tiles/stone2.png',
      'tiles/stone3.png',
      'tiles/wall1.png',
      'tiles/wall2.png',
      'tiles/wall3.png',
      'tiles/lava1.gif',
      'tiles/lava2.gif',
      'tiles/lava3.gif',
      'tiles/water1.png',
      'tiles/water2.png',
      'tiles/water3.png',
      'sprites/player1_n.png',
      'sprites/player1_e.png',
      'sprites/player1_s.png',
      'sprites/player1_w.png'
    ];

    loadImages(sources, function(imagesOut) {
      images = imagesOut;

      init();
    });

    function arraysEqual(a, b) {
      if (a === b) return true;
      if (a == null || b == null) return false;
      if (a.length != b.length) return false;

      // If you don't care about the order of the elements inside
      // the array, you should sort both arrays here.

      for (var i = 0; i < a.length; ++i) {
        if (a[i] !== b[i]) return false;
      }
      return true;
    }

    function init() {
      document.onkeydown = checkKey;
      function checkKey(e) {

        e = e || window.event;
        var msg = {uuid: uuid, type: 'move'};

        if (e.keyCode == '38') {
          msg.dir = 'n';
        }
        else if (e.keyCode == '40') {
          msg.dir = 's';
        }
        else if (e.keyCode == '37') {
          msg.dir = 'w';
        }
        else if (e.keyCode == '39') {
          msg.dir = 'e';
        } else {
          return false;
        }

        socket.send(JSON.stringify(msg));

      }


      // create socket object, everything will be sent over this
      socket = new WebSocket(url, "echo-protocol");

      socket.addEventListener("open", function(event) {
        // this runs when the socket is first opened

      });

      socket.addEventListener("message", function(event) {
        // this runs when the socket receives a message from the server
        try {
          // res contains the json representation of the protocol
          var cmd = JSON.parse(event.data);

          if (cmd.uuid && uuid == undefined) {
            // we've received a uuid, use that locally
            uuid = cmd.uuid;
            console.log(uuid + ' assigned!');
            socket.send(JSON.stringify({uuid: uuid, type: 'get_rooms'}));
          }
          if (cmd.type != undefined) {
            switch(cmd.type) {
              case 'map':
                populate(cmd.map);
              case 'room_info':
                var result_string = '';
                for (var room_index in cmd.rooms) {
                  var cur_room = cmd.rooms[room_index];
                  result_string += '\
                    <div class="intro__container">\
                      <div class="intro__containerTitle--small">\
                      ' + cur_room.players + ' Players\
                    </div>\
                    <div class="intro__containerButton">\
                      <button id="' + room_index + '" onClick="join_room(this.id)">Join This Dungeon</button>\
                    </div>\
                    </div>'
                }
                $('#intro__joinContainer').html(result_string);
                break;
            }
          }

        } catch (e) {
          // console.log(e);
        }
        //console.log('[SERVER] ' + event.data);
      });

      // when an error happens, this is triggered
      socket.addEventListener("error", function(event) {
        message.textContent = "Error: " + event;
      });

      socket.addEventListener("close", function(event) {
        open.disabled = false;
      });
    }

  </script>
</body>
</html>